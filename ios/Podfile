# =====================================================
# Podfile for Flutter iOS Project
# =====================================================
# This file manages external library dependencies for iOS projects through CocoaPods.
# CocoaPods is the most widely used dependency management tool in iOS development.

# -----------------------------------------------------
# 1. Platform and Minimum Version Settings
# -----------------------------------------------------
# Set the minimum iOS version that the iOS app will support.
# ChannelIOSDK 12.5.0 or later requires iOS 15.0 or later.
platform :ios, '15.0'

# -----------------------------------------------------
# 2. CocoaPods Performance Optimization Settings
# -----------------------------------------------------
# Disable CocoaPods analytics data collection to improve build speed.
# Prevents delays from unnecessary network communication during Flutter builds.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

# -----------------------------------------------------
# 3. Project Build Configuration Settings
# -----------------------------------------------------
# Define build configurations for the Xcode project.
# Debug: for development, Profile: for profiling, Release: for deployment
project 'Runner', {
  'Debug' => :debug,      # Debug build settings
  'Profile' => :release,  # Profile build settings (for optimized performance testing)
  'Release' => :release,  # Release build settings (for App Store deployment)
}

# -----------------------------------------------------
# 4. Flutter Framework Settings (Auto-generated code)
# -----------------------------------------------------
# Function to find the path to the Flutter SDK.
# This function reads the FLUTTER_ROOT path from the configuration file generated by Flutter.
def flutter_root
  # Path to configuration file generated by Flutter
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  
  # Error occurs if configuration file does not exist
  # In this case, 'flutter pub get' must be executed first.
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  # Find and return FLUTTER_ROOT path from configuration file
  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  
  # Error occurs if FLUTTER_ROOT is not found
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

# Load Flutter's CocoaPods helper script.
# This script automatically configures Flutter plugins.
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

# Execute Flutter iOS project initial setup.
flutter_ios_podfile_setup

# -----------------------------------------------------
# 5. Main App Target Settings
# -----------------------------------------------------
# 'Runner' is the target name of the main iOS app.
target 'Runner' do
  # Configure to use Dynamic Framework.
  # This facilitates smooth mixed use of Swift and Objective-C code.
  use_frameworks!
  
  # Use modular headers to improve import performance.
  use_modular_headers!

  # Automatically install all plugins used in Flutter.
  # Flutter plugins defined in pubspec.yaml are installed here for iOS.
  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  
  # -----------------------------------------------------
  # Additional Native Library Settings
  # -----------------------------------------------------
  # Add native iOS libraries to be used in Flutter.
  # ChannelIOSDK: Always uses the latest version if no version is specified.
  pod 'ChannelIOSDK'
end

# -----------------------------------------------------
# 6. Test Target Settings
# -----------------------------------------------------
# 'RunnerTests' is a target for unit tests.
target 'RunnerTests' do
  # Inherit search paths from the main target.
  # This allows tests to access the main app's code.
  inherit! :search_paths
end

# -----------------------------------------------------
# 7. Additional Settings After Pod Installation
# -----------------------------------------------------
# Script executed after all CocoaPods are installed.
# Here you can finely adjust the build settings of each Pod.
post_install do |installer|
  # Iterate through all installed Pod targets.
  installer.pods_project.targets.each do |target|
    # Apply iOS build settings required by Flutter to each target.
    # This ensures compatibility between Flutter and native code.
    flutter_additional_ios_build_settings(target)
    
    # Iterate through all target build configurations (Debug, Profile, Release).
    target.build_configurations.each do |config|
      # Set iOS deployment target to 15.0.
      # This is to satisfy the minimum requirements of ChannelIOSDK.
      # Force all Pods to use the same deployment target to prevent compatibility issues.
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
    end
  end
end

# =====================================================
# Podfile Description Summary
# =====================================================
# 1. This file manages external library dependencies for iOS projects.
# 2. Install the libraries defined here with the 'pod install' command.
# 3. After installation, open the 'Runner.xcworkspace' file for development.
# 4. After adding new Pods, be sure to run 'pod install' again.
# =====================================================
